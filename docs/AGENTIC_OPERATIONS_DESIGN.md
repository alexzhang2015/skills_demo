# 下一代 Agentic Operations 技术设计文档

> 面向企业运营场景的 AI Agent 系统架构设计
> Version: 2.1 | Last Updated: 2025-01

---

## 目录

1. [愿景与目标](#1-愿景与目标)
2. [为什么运营动作可以被 Skills 化](#2-为什么运营动作可以被-skills-化)
3. [核心概念：Memory = Filesystem](#3-核心概念memory--filesystem)
4. [Claude Skills 原理与机制](#4-claude-skills-原理与机制)
5. [系统架构设计](#5-系统架构设计)
6. [Skills 体系设计](#6-skills-体系设计)
7. [MCP 工具层设计](#7-mcp-工具层设计)
8. [落地路径规划](#8-落地路径规划)
9. [典型场景实现](#9-典型场景实现)
10. [治理与运维](#10-治理与运维)
11. [当前实现状态](#11-当前实现状态)
12. [附录](#12-附录)

---

## 1. 愿景与目标

### 1.1 愿景

构建面向企业运营人员的下一代 AI Agent 系统，通过 **Skills 沉淀** 将运营场景标准化、自动化，逐步提升运营效率。

### 1.2 核心目标

| 目标 | 描述 | 衡量指标 |
|------|------|---------|
| **效率提升** | 减少重复性操作时间 | 单任务耗时降低 80% |
| **知识沉淀** | 将运营经验转化为可复用 Skills | Skills 复用率 > 60% |
| **降低门槛** | 非技术人员可自助完成常规操作 | 自助完成率 > 70% |
| **风险可控** | 关键操作有审批和回滚机制 | 误操作回滚成功率 100% |

### 1.3 设计原则

```
┌─────────────────────────────────────────────────────────────────┐
│                        设计原则                                  │
├─────────────────────────────────────────────────────────────────┤
│  1. Memory = Filesystem     文件系统即 Agent 记忆               │
│  2. Skills as Code          技能即代码，可版本控制               │
│  3. Progressive Disclosure  渐进式披露，按需加载                 │
│  4. Human-in-the-Loop       关键节点保留人工决策                 │
│  5. Audit Everything        全链路可审计                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 为什么运营动作可以被 Skills 化

### 2.1 本质洞察：运营动作 = SOP 执行

企业运营的本质是**执行标准操作流程（SOP）**。无论是商品上新、价格调整还是活动配置，背后都是一系列结构化的操作步骤：

```
┌─────────────────────────────────────────────────────────────────┐
│                    运营动作的本质结构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  运营动作                                                        │
│     ↓                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    SOP（标准操作流程）                    │   │
│  │  ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐      │   │
│  │  │步骤1│ → │步骤2│ → │步骤3│ → │步骤4│ → │步骤n│      │   │
│  │  │登录 │   │填表 │   │校验 │   │提交 │   │确认 │      │   │
│  │  └─────┘   └─────┘   └─────┘   └─────┘   └─────┘      │   │
│  └─────────────────────────────────────────────────────────┘   │
│     ↓                                                           │
│  Skills 化                                                       │
│     ↓                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    SKILL.md                              │   │
│  │  • 步骤描述 → 自然语言指令                               │   │
│  │  • 操作对象 → 页面元素/API 参数                          │   │
│  │  • 判断逻辑 → 条件分支                                   │   │
│  │  • 异常处理 → 错误恢复策略                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 SOP 与 Skill 的同构映射

SOP 的每个组成部分都能直接映射到 Skill 的对应结构：

| SOP 组成 | Skill 对应 | 示例 |
|---------|-----------|------|
| **流程名称** | `name` + `description` | 商品上新流程 |
| **输入要素** | `inputs` 参数定义 | 商品名、价格、分类 |
| **操作步骤** | Markdown 步骤说明 | Step 1: 登录系统... |
| **系统操作** | MCP 工具调用 | `browser_click`, `browser_fill` |
| **判断条件** | 条件逻辑描述 | 如果价格>100，需审批 |
| **异常处理** | 常见问题章节 | Q: 同步失败怎么办？ |
| **输出结果** | `outputs` 定义 | 商品ID、同步状态 |

### 2.3 可 Skills 化的判断标准

并非所有运营动作都适合 Skills 化。以下是判断标准：

```
┌─────────────────────────────────────────────────────────────────┐
│                   可 Skills 化评估矩阵                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│        高 ┌────────────────────────────────────────┐            │
│          │                        │                │            │
│    重    │   ⚠️ 需要审批流        │  ✅ 最佳场景   │            │
│    复    │   价格调整、活动上线   │  商品上新      │            │
│    频    │                        │  菜单配置      │            │
│    率    │                        │  库存查询      │            │
│          ├────────────────────────┼────────────────┤            │
│          │                        │                │            │
│          │   ❌ 不适合            │  ⚡ 可考虑     │            │
│          │   一次性任务           │  低频但固定    │            │
│          │   高度创意性工作       │  月度报表      │            │
│          │                        │                │            │
│        低 └────────────────────────────────────────┘            │
│              低 ←──── 流程标准化程度 ────→ 高                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

✅ 适合 Skills 化的特征：
   • 流程固定、步骤明确
   • 重复频率高（每天/每周执行）
   • 涉及多系统操作
   • 操作耗时但技术含量低
   • 有明确的输入输出

❌ 不适合 Skills 化的特征：
   • 高度依赖主观判断
   • 每次执行差异大
   • 一次性或极低频任务
   • 需要复杂创意思维
```

### 2.4 Skills 化的价值本质

Skills 化不仅是自动化，更是**组织知识的结构化沉淀**：

```
┌─────────────────────────────────────────────────────────────────┐
│                    Skills 化的三层价值                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Layer 1: 效率价值（显性）                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  • 执行时间：30分钟 → 3分钟                              │   │
│  │  • 人力成本：释放重复劳动                                │   │
│  │  • 错误率：人工失误 → 接近零                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Layer 2: 知识价值（隐性）                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  • SOP 显性化：隐性经验 → 可读文档                       │   │
│  │  • 知识传承：老员工经验 → 组织资产                       │   │
│  │  • 最佳实践：散落各处 → 统一标准                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Layer 3: 演进价值（长期）                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  • 持续优化：执行数据 → 流程改进                         │   │
│  │  • 版本迭代：业务变化 → Skill 更新                       │   │
│  │  • 生态积累：单点 Skill → Skills 库                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.5 从 SOP 到 Skill 的转化路径

```
┌─────────────────────────────────────────────────────────────────┐
│                 SOP → Skill 转化流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  现状：SOP 散落各处                                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │ Word文档 │ │ 口口相传 │ │ Wiki页面 │ │ 培训PPT  │          │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘          │
│       └────────────┼────────────┼────────────┘                 │
│                    ↓                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Step 1: SOP 梳理                                        │   │
│  │  • 收集现有文档和经验                                    │   │
│  │  • 标准化流程步骤                                        │   │
│  │  • 识别输入/输出/判断点                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                    ↓                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Step 2: 操作录制（可选）                                │   │
│  │  • 业务人员使用 Chrome 录制实际操作                      │   │
│  │  • 捕获页面元素和操作序列                                │   │
│  │  • 生成原始操作日志                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                    ↓                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Step 3: Skill 编写                                      │   │
│  │  • Claude 辅助理解操作意图                               │   │
│  │  • 参数化可变内容                                        │   │
│  │  • 补充异常处理和边界情况                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                    ↓                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Step 4: 验证与发布                                      │   │
│  │  • 沙箱环境测试                                          │   │
│  │  • 技术审核                                              │   │
│  │  • 发布到 Skills 仓库                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                    ↓                                            │
│  结果：结构化 Skill                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  .claude/skills/product-launch/SKILL.md                 │   │
│  │  • 版本控制 ✓                                            │   │
│  │  • 可复用 ✓                                              │   │
│  │  • 可迭代 ✓                                              │   │
│  │  • 可审计 ✓                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.6 典型运营场景的 SOP 分析

以"商品上新"为例，分析其 SOP 结构：

| SOP 步骤 | 操作内容 | 系统 | 耗时 | Skills 化方式 |
|---------|---------|------|------|--------------|
| 1. 准备 | 收集商品信息 | - | 10min | `inputs` 参数接收 |
| 2. 创建 | 在 ERP 创建 SKU | ERP | 5min | Playwright 自动填表 |
| 3. 配置 | POS 菜单配置 | POS后台 | 5min | Playwright 自动配置 |
| 4. 上架 | 小程序上架发布 | 小程序后台 | 5min | Playwright 自动发布 |
| 5. 验证 | 检查各渠道状态 | 多系统 | 5min | 自动截图+状态检查 |
| **总计** | | | **30min** | **→ 3min** |

**关键洞察**：
- 步骤 2-4 是纯机械操作，100% 可自动化
- 步骤 1 需要人工输入，但可通过参数化简化
- 步骤 5 可自动化但需人工确认兜底

---

## 3. 核心概念：Memory = Filesystem

基于认知科学的三层记忆模型，将 Agent 的记忆系统映射到文件系统结构：

```
┌────────────────────────────────────────────────────────────────┐
│                    Memory = Filesystem                         │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Procedural Memory（程序性记忆）                          │  │
│  │  "如何做事" - Agent 的行为模式和工具能力                   │  │
│  │                                                          │  │
│  │  ├── CLAUDE.md          项目指令、角色定义、行为规范       │  │
│  │  └── mcp.json           MCP 工具配置和连接                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Semantic Memory（语义记忆）                              │  │
│  │  "知道什么" - 领域知识和操作技能                          │  │
│  │                                                          │  │
│  │  ├── skills/                                             │  │
│  │  │   ├── product-launch/                                 │  │
│  │  │   │   ├── SKILL.md           技能主文件               │  │
│  │  │   │   ├── references/        参考资料                 │  │
│  │  │   │   └── examples/          示例集                   │  │
│  │  │   └── menu-management/                                │  │
│  │  │       └── SKILL.md                                    │  │
│  │  │                                                       │  │
│  │  └── knowledge/                                          │  │
│  │      ├── business-rules.md      业务规则                 │  │
│  │      ├── system-guide.md        系统操作指南             │  │
│  │      └── glossary.md            术语表                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Episodic Memory（情景记忆）                              │  │
│  │  "经历过什么" - 历史执行记录和学习素材                    │  │
│  │                                                          │  │
│  │  ├── conversations/                                      │  │
│  │  │   ├── 2024-01-15_product_launch.json                 │  │
│  │  │   └── 2024-01-16_price_adjust.json                   │  │
│  │  │                                                       │  │
│  │  ├── executions/                                         │  │
│  │  │   ├── exec_001.json          执行记录                 │  │
│  │  │   └── exec_002.json                                   │  │
│  │  │                                                       │  │
│  │  └── recordings/                                         │  │
│  │      └── chrome_recording_001.json  Chrome 录制          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 3.1 三层记忆的职责

| 记忆类型 | 文件类型 | 加载时机 | 更新频率 |
|---------|---------|---------|---------|
| **Procedural** | CLAUDE.md, mcp.json | Agent 启动时 | 低（架构变更时） |
| **Semantic** | SKILL.md, knowledge/*.md | 任务匹配时 | 中（技能迭代时） |
| **Episodic** | conversations/, executions/ | 按需检索 | 高（每次执行后） |

### 3.2 记忆检索机制

```
用户输入: "帮我上新一个商品，名字叫冰美式"
                    ↓
        ┌─────────────────────┐
        │  1. 意图识别        │
        │  检索 Procedural    │
        │  确定 Agent 角色    │
        └──────────┬──────────┘
                   ↓
        ┌─────────────────────┐
        │  2. 技能匹配        │
        │  检索 Semantic      │
        │  匹配 SKILL.md      │
        └──────────┬──────────┘
                   ↓
        ┌─────────────────────┐
        │  3. 上下文增强      │
        │  检索 Episodic      │
        │  获取历史经验       │
        └──────────┬──────────┘
                   ↓
        ┌─────────────────────┐
        │  4. 执行 & 记录     │
        │  更新 Episodic      │
        │  沉淀新经验         │
        └─────────────────────┘
```

---

## 4. Claude Skills 原理与机制

Claude Skills 是 Claude Code 的核心扩展机制，允许通过 Markdown 文件定义可复用的专业能力。

### 4.1 Skills 工作原理

```
┌─────────────────────────────────────────────────────────────────┐
│                    Claude Skills 运行机制                        │
└─────────────────────────────────────────────────────────────────┘

                        ┌─────────────────┐
                        │  Claude Code    │
                        │  启动加载       │
                        └────────┬────────┘
                                 │
                                 ↓
              ┌──────────────────────────────────┐
              │  Phase 1: Discovery（发现）       │
              │  ┌────────────────────────────┐  │
              │  │ 扫描 Skills 目录:          │  │
              │  │ • ~/.claude/skills/        │  │
              │  │ • .claude/skills/          │  │
              │  │ • 插件 skills/             │  │
              │  │                            │  │
              │  │ 仅加载 name + description  │  │
              │  │ （轻量索引，节省 tokens）   │  │
              │  └────────────────────────────┘  │
              └──────────────────┬───────────────┘
                                 │
                                 ↓
              ┌──────────────────────────────────┐
              │  Phase 2: Matching（匹配）        │
              │  ┌────────────────────────────┐  │
              │  │ 用户输入: "帮我上新一个商品" │  │
              │  │            ↓               │  │
              │  │ 语义匹配 Skills 描述:      │  │
              │  │ • product-launch ✓ 匹配    │  │
              │  │ • menu-management ✗        │  │
              │  │ • price-adjustment ✗       │  │
              │  └────────────────────────────┘  │
              └──────────────────┬───────────────┘
                                 │
                                 ↓
              ┌──────────────────────────────────┐
              │  Phase 3: Activation（激活）      │
              │  ┌────────────────────────────┐  │
              │  │ Claude 请求使用 Skill:     │  │
              │  │ "我找到了 product-launch   │  │
              │  │  技能，是否使用？"          │  │
              │  │            ↓               │  │
              │  │ 用户确认 → 加载完整内容    │  │
              │  │ • SKILL.md 主文件          │  │
              │  │ • 按需加载 references/     │  │
              │  └────────────────────────────┘  │
              └──────────────────┬───────────────┘
                                 │
                                 ↓
              ┌──────────────────────────────────┐
              │  Phase 4: Execution（执行）       │
              │  ┌────────────────────────────┐  │
              │  │ Claude 按 SKILL.md 指令:   │  │
              │  │ • 理解执行步骤             │  │
              │  │ • 调用 allowed-tools       │  │
              │  │ • 遵循约束和规范           │  │
              │  │ • 处理异常情况             │  │
              │  └────────────────────────────┘  │
              └──────────────────────────────────┘
```

### 4.2 Skills 加载优先级

当存在同名 Skill 时，按以下优先级加载（高优先级覆盖低优先级）：

```
┌─────────────────────────────────────────────────────────────────┐
│  优先级（从高到低）                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Enterprise（企业托管）     最高优先级，企业统一管控          │
│     └── 通过 Managed Settings 分发                              │
│                                                                 │
│  2. Personal（个人）           用户个人自定义                    │
│     └── ~/.claude/skills/                                       │
│                                                                 │
│  3. Project（项目）            项目级共享                        │
│     └── .claude/skills/                                         │
│                                                                 │
│  4. Plugin（插件）             第三方插件提供                    │
│     └── 插件目录/skills/                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 渐进式加载（Progressive Disclosure）

Skills 采用渐进式加载策略，优化 token 使用和响应速度：

```
┌─────────────────────────────────────────────────────────────────┐
│  Token 消耗优化策略                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  启动时加载（始终）:                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  name: product-launch                         ~50 tokens │   │
│  │  description: 商品上新流程。当用户提到...      ~100 tokens │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  匹配后加载（按需）:                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  SKILL.md 完整内容                          ~2000 tokens │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  执行时加载（按需）:                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  references/erp-guide.md                     ~500 tokens │   │
│  │  references/validation-rules.md              ~300 tokens │   │
│  │  （仅在 Claude 判断需要时加载）                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  从不加载（仅执行）:                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  scripts/validate.py                           0 tokens │   │
│  │  （脚本被执行，输出结果进入上下文）                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.4 SKILL.md 核心字段

| 字段 | 必需 | 说明 |
|------|------|------|
| `name` | ✓ | 技能唯一标识，小写字母+连字符，最长64字符 |
| `description` | ✓ | 技能描述，Claude 用于判断何时激活，最长1024字符 |
| `allowed-tools` | - | 无需额外授权即可使用的工具列表 |
| `model` | - | 指定使用的 Claude 模型 |
| `context` | - | 设为 `fork` 时在隔离子进程中执行 |
| `agent` | - | 配合 `context: fork` 使用，指定 agent 类型 |
| `user-invocable` | - | 设为 `false` 时不显示在 /slash 菜单中 |

### 4.5 Description 编写最佳实践

Description 是 Claude 判断是否激活 Skill 的关键，编写时应回答两个问题：

```markdown
# 好的 Description 示例

description: |
  商品上新流程。将新商品从创建到全渠道上架。
  当用户提到：新品上架、商品上新、创建新SKU、添加新商品、上新品时使用。

# 分析：
# 1. "做什么" - 商品上新流程，全渠道上架
# 2. "何时用" - 明确列出触发关键词
```

```markdown
# 不好的 Description 示例

description: 处理商品相关操作

# 问题：
# 1. 太模糊，无法区分是上新、下架还是修改
# 2. 没有列出触发关键词
```

### 4.6 与 MCP 工具的协作

Skills 通过 `allowed-tools` 字段声明可使用的 MCP 工具：

```yaml
allowed-tools:
  - mcp__playwright__browser_*      # 通配符匹配所有 playwright 浏览器工具
  - mcp__database__query            # 精确匹配单个工具
  - Read                            # Claude Code 内置工具
  - Write
```

**工具权限模型**：

```
┌─────────────────────────────────────────────────────────────────┐
│  工具调用权限检查流程                                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Claude 需要调用工具                                             │
│         ↓                                                       │
│  ┌─────────────────────┐                                       │
│  │ 工具在 allowed-tools│── Yes ──→ 直接执行，无需确认           │
│  │ 列表中？            │                                       │
│  └─────────────────────┘                                       │
│         │ No                                                    │
│         ↓                                                       │
│  ┌─────────────────────┐                                       │
│  │ 请求用户授权        │── 用户确认 ──→ 执行                    │
│  │                     │── 用户拒绝 ──→ 跳过或终止              │
│  └─────────────────────┘                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.7 Skills 与 CLAUDE.md 的关系

```
┌─────────────────────────────────────────────────────────────────┐
│  配置层级与作用域                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  CLAUDE.md（全局）                                               │
│  ├── 项目级指令和约束                                            │
│  ├── 始终生效，所有对话                                          │
│  └── 定义 Agent 角色、通用规范                                   │
│                                                                 │
│  SKILL.md（局部）                                                │
│  ├── 特定任务的专业指令                                          │
│  ├── 仅在激活时生效                                              │
│  └── 定义具体操作步骤、工具权限                                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  执行时的指令合并:                                       │   │
│  │  CLAUDE.md 全局规范 + SKILL.md 任务指令 = 完整上下文     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 系统架构设计

### 5.1 四层 Agent 架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      用户自然语言输入                            │
│              "帮我把冰美式上架到全国门店"                         │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│  Layer 1: Master Agent（意图路由层）                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  • 自然语言理解                                            │  │
│  │  • 意图分类（product_launch, price_adjust, campaign...）   │  │
│  │  • 实体提取（商品名、价格、区域、日期）                      │  │
│  │  • 执行计划生成                                            │  │
│  │  • 多 Agent 结果聚合                                       │  │
│  └───────────────────────────────────────────────────────────┘  │
│  文件: CLAUDE.md 中定义 Master Agent 行为规范                    │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│  Layer 2: Sub-scenario Agents（领域专家层）                      │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ Product │ │ Pricing │ │Marketing│ │ Supply  │ │Analytics│   │
│  │  Agent  │ │  Agent  │ │  Agent  │ │  Chain  │ │  Agent  │   │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘   │
│       │           │           │           │           │         │
│  每个 Agent 有独立的 system_prompt 和 capabilities              │
│  文件: CLAUDE.md 中定义各领域 Agent 角色和能力                    │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│  Layer 3: Workflow Engine（流程编排层）                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Workflow: product-launch-workflow                        │  │
│  │  ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   │  │
│  │  │创建  │ → │配置  │ → │审批  │ → │同步  │ → │验证  │   │  │
│  │  │SKU   │   │POS   │   │节点  │   │APP   │   │结果  │   │  │
│  │  └──────┘   └──────┘   └──────┘   └──────┘   └──────┘   │  │
│  │                          ↑                               │  │
│  │                     Human-in-the-Loop                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│  文件: skills/*/SKILL.md 中定义执行步骤                          │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│  Layer 4: Skill Executor（原子执行层）                           │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Atomic Skills:                                           │  │
│  │  • create-sku        • config-pos-item    • sync-app     │  │
│  │  • update-price      • create-campaign    • send-notify  │  │
│  │                                                           │  │
│  │  MCP Tools:                                               │  │
│  │  • mcp__playwright__browser_*    浏览器自动化             │  │
│  │  • mcp__database__query          数据库查询               │  │
│  │  • mcp__api__call                API 调用                 │  │
│  └───────────────────────────────────────────────────────────┘  │
│  文件: mcp.json 定义工具连接                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 执行模式选择

根据场景复杂度选择执行模式：

| 模式 | 触发条件 | 经过层级 | 典型场景 |
|------|---------|---------|---------|
| **轻量模式** | 单一明确操作 | L1 → L4 | 查询库存、查看报表 |
| **标准模式** | 单领域操作 | L1 → L2 → L4 | 商品上新、价格调整 |
| **复杂模式** | 跨领域协作 | L1 → L2 → L3 → L4 | 新品发布活动、季节性促销 |

### 5.3 交付形态演进

```
┌─────────────────────────────────────────────────────────────────┐
│  P0 试点阶段                                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Claude Code CLI                        │  │
│  │  用户: 技术运营 / 运营骨干                                  │  │
│  │  目标: 验证 Skills 可行性                                   │  │
│  │  形态: CLI + VS Code 插件                                   │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│  P1 扩展阶段                                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              轻量 Web 壳 + Claude Agent SDK                │  │
│  │  用户: 普通运营人员                                         │  │
│  │  目标: 降低使用门槛                                         │  │
│  │  形态: Web 应用（常用场景入口）+ CLI（高级操作）             │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│  P2 规模化阶段                                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    企业级应用平台                           │  │
│  │  用户: 全体运营人员                                         │  │
│  │  目标: 全面提效                                             │  │
│  │  形态: 企业 UI + 权限管理 + 审批流 + 审计日志               │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. Skills 体系设计

### 6.1 SKILL.md 规范

基于 Claude Code 原生格式，扩展企业场景需求：

```yaml
---
# ═══════════════════════════════════════════════════════════════
# Part 1: Claude Code 原生字段（P0 阶段直接使用）
# ═══════════════════════════════════════════════════════════════
name: product-launch
description: |
  商品上新流程。将新商品从创建到全渠道上架。
  当用户提到：新品上架、商品上新、创建新SKU、上新品时使用。

# 允许的工具列表（无需额外授权）
allowed-tools:
  - mcp__playwright__browser_*
  - Read
  - Write

# 可选：指定模型
model: claude-sonnet-4-20250514

# 可选：隔离上下文执行
context: fork
agent: general-purpose

# ═══════════════════════════════════════════════════════════════
# Part 2: 企业扩展字段（P1/P2 阶段 Agent SDK 解析）
# Claude Code 会忽略这些字段，不影响 P0 使用
# ═══════════════════════════════════════════════════════════════

# 元信息
version: "1.0"
category: 商品管理
owner: 商品运营组
tags: [商品, 上新, SKU]

# 输入参数 Schema
inputs:
  - name: product_name
    type: string
    required: true
    description: 商品名称
    validation: "length >= 2 && length <= 50"

  - name: price
    type: number
    required: true
    description: 销售价格（元）
    validation: "value > 0 && value < 10000"

  - name: category
    type: enum
    required: true
    options: [咖啡, 茶饮, 果饮, 小食, 甜点, 周边]

  - name: regions
    type: array
    items: string
    default: ["全国"]
    description: 上架区域

# 输出 Schema
outputs:
  - name: product_id
    type: string
    description: 创建的商品ID

  - name: sync_status
    type: object
    description: 各渠道同步状态

# 目标系统（用于权限校验）
target_systems:
  - id: erp
    name: 商品中台
    type: WEB
    required_permissions: [product:create, product:update]

  - id: pos
    name: POS后台
    type: WEB
    required_permissions: [menu:config]

  - id: app
    name: 小程序后台
    type: WEB
    required_permissions: [product:publish]

# 审批配置
approval:
  required: false  # 默认不需要审批
  rules:
    - condition: "price > 100"
      approvers: [商品经理]
      reason: "高价商品需审批"

    - condition: "regions.includes('全国')"
      approvers: [运营总监]
      reason: "全国上架需审批"

# 执行配置
execution:
  estimated_duration: 15min
  timeout: 30min
  retry:
    max_attempts: 3
    backoff: exponential
  rollback_supported: true

# 依赖的其他 Skills
dependencies:
  - skill: login-erp
    when: always
  - skill: validate-product
    when: before_create

# 触发器（自动化场景）
triggers:
  - type: schedule
    cron: "0 9 * * 1"  # 每周一早9点
    condition: "pending_products.length > 0"

  - type: webhook
    endpoint: /api/skills/product-launch/trigger
    auth: api_key
---

# 商品上新

## 概述

本技能用于将新商品完成全渠道上架...

## 执行步骤

### Step 1: 创建商品主数据
...

### Step 2: 配置 POS
...
```

### 6.2 Skills 目录结构

参考 Vercel 团队的 Progressive Disclosure 模式：

```
.claude/skills/
│
├── product-launch/                    # 商品上新
│   ├── SKILL.md                       # 主文件（< 500 行）
│   ├── references/                    # 参考资料（按需加载）
│   │   ├── erp-field-mapping.md       # ERP 字段映射
│   │   ├── pos-config-guide.md        # POS 配置指南
│   │   └── validation-rules.md        # 校验规则
│   ├── examples/                      # 示例集
│   │   ├── simple-product.md          # 简单商品示例
│   │   └── combo-product.md           # 套餐商品示例
│   └── scripts/                       # 辅助脚本
│       └── validate-input.py          # 输入校验脚本
│
├── menu-management/                   # 菜单运营
│   ├── SKILL.md
│   └── references/
│       └── menu-layout-rules.md
│
├── price-adjustment/                  # 价格调整
│   ├── SKILL.md
│   └── references/
│       ├── pricing-strategy.md
│       └── competitor-analysis.md
│
├── campaign-setup/                    # 活动配置
│   ├── SKILL.md
│   └── references/
│       └── promotion-types.md
│
└── _shared/                           # 共享组件
    ├── login/                         # 登录相关
    │   ├── login-erp.md
    │   ├── login-pos.md
    │   └── login-app.md
    ├── validation/                    # 通用校验
    │   └── common-validations.md
    └── templates/                     # 模板
        └── skill-template.md
```

### 6.3 Skills 生命周期

```
┌─────────────────────────────────────────────────────────────────┐
│                     Skills 生命周期                              │
└─────────────────────────────────────────────────────────────────┘

  ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
  │  创建    │ ──→ │  测试    │ ──→ │  发布    │ ──→ │  运行    │
  │  Draft   │     │  Testing │     │  Active  │     │  Running │
  └──────────┘     └──────────┘     └──────────┘     └──────────┘
       ↑                                 │                 │
       │                                 ↓                 ↓
       │           ┌──────────┐     ┌──────────┐     ┌──────────┐
       └────────── │  迭代    │ ←── │  监控    │ ←── │  反馈    │
                   │  Update  │     │  Monitor │     │  Feedback│
                   └──────────┘     └──────────┘     └──────────┘

创建来源：
  • 技术人员手写
  • Chrome 录制 + Claude 辅助参数化
  • 历史对话提炼
```

### 6.4 Chrome 录制 → SKILL.md 流程

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 业务人员操作录制                                        │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Chrome for Claude 录制功能                                │  │
│  │  • 记录点击、输入、等待等操作                               │  │
│  │  • 捕获页面元素选择器                                       │  │
│  │  • 生成原始操作序列                                         │  │
│  └───────────────────────────────────────────────────────────┘  │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 2: Claude 辅助理解和参数化                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  输入：原始录制 JSON                                        │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  { "actions": [                                     │  │  │
│  │  │    { "type": "click", "selector": "#menu-btn" },    │  │  │
│  │  │    { "type": "fill", "selector": "#name",           │  │  │
│  │  │      "value": "冰美式" },                           │  │  │
│  │  │    { "type": "fill", "selector": "#price",          │  │  │
│  │  │      "value": "28" }                                │  │  │
│  │  │  ]}                                                 │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                           ↓                               │  │
│  │  Claude 分析：                                             │  │
│  │  • 识别操作意图："创建新商品"                               │  │
│  │  • 提取可变参数：product_name, price                       │  │
│  │  • 生成参数化 SKILL.md 草稿                                │  │
│  └───────────────────────────────────────────────────────────┘  │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 3: 技术人员审核和优化                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  • 优化选择器稳定性                                         │  │
│  │  • 添加错误处理和重试逻辑                                    │  │
│  │  • 补充边界条件                                             │  │
│  │  • 添加审批规则                                             │  │
│  │  • Code Review & 合并到主分支                               │  │
│  └───────────────────────────────────────────────────────────┘  │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│  Step 4: 发布到 Skills 仓库                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  • 版本号递增                                               │  │
│  │  • 更新变更日志                                             │  │
│  │  • 通知相关运营人员                                         │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. MCP 工具层设计

### 7.1 MCP 服务器架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        mcp.json 配置                             │
└─────────────────────────────────────────────────────────────────┘

{
  "mcpServers": {

    // 浏览器自动化 - 核心工具
    "playwright": {
      "command": "npx",
      "args": ["@anthropic/mcp-playwright"],
      "env": {
        "BROWSER": "chromium",
        "HEADLESS": "false"  // P0 阶段可视化调试
      }
    },

    // 企业内部系统 API
    "enterprise-api": {
      "command": "python",
      "args": ["mcp_servers/enterprise_api.py"],
      "env": {
        "API_BASE_URL": "${ENTERPRISE_API_URL}",
        "API_KEY": "${ENTERPRISE_API_KEY}"
      }
    },

    // 数据查询
    "database": {
      "command": "python",
      "args": ["mcp_servers/database.py"],
      "env": {
        "DB_CONNECTION": "${DB_CONNECTION_STRING}",
        "READ_ONLY": "true"  // 安全限制
      }
    },

    // 文件操作
    "filesystem": {
      "command": "npx",
      "args": ["@anthropic/mcp-filesystem"],
      "env": {
        "ALLOWED_PATHS": "/data/exports,/tmp/claude"
      }
    }
  }
}
```

### 7.2 工具分类与权限

| 工具类别 | MCP Server | 权限级别 | 使用场景 |
|---------|------------|---------|---------|
| **浏览器** | playwright | Medium | 系统界面操作 |
| **API** | enterprise-api | High | 直接调用业务 API |
| **数据库** | database | Read-Only | 数据查询和报表 |
| **文件** | filesystem | Restricted | 导出数据和报告 |

### 7.3 工具调用链路追踪

```
┌─────────────────────────────────────────────────────────────────┐
│  Skill Execution                                                │
│  skill_id: product-launch                                       │
│  session_id: sess_20240115_001                                  │
└──────────────────────────┬──────────────────────────────────────┘
                           │
    ┌──────────────────────┼──────────────────────┐
    ↓                      ↓                      ↓
┌─────────┐          ┌─────────┐          ┌─────────┐
│ Step 1  │          │ Step 2  │          │ Step 3  │
│ 创建SKU │          │ 配置POS │          │ 同步APP │
└────┬────┘          └────┬────┘          └────┬────┘
     │                    │                    │
     ↓                    ↓                    ↓
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ MCP Calls:  │    │ MCP Calls:  │    │ MCP Calls:  │
│ • navigate  │    │ • navigate  │    │ • navigate  │
│ • fill_form │    │ • click     │    │ • upload    │
│ • click     │    │ • fill      │    │ • click     │
│ trace_id:   │    │ trace_id:   │    │ trace_id:   │
│ mcp_001     │    │ mcp_002     │    │ mcp_003     │
└─────────────┘    └─────────────┘    └─────────────┘
                           │
                           ↓
              ┌─────────────────────┐
              │  Execution Log      │
              │  (Episodic Memory)  │
              │  executions/        │
              │  exec_001.json      │
              └─────────────────────┘
```

---

## 8. 落地路径规划

### 8.1 P0 阶段：试点验证（1-2 个月）

**目标**：验证 Skills 体系可行性

**范围**：
- 用户：5-10 名技术运营骨干
- 场景：商品上新、菜单运营
- 工具：Claude Code CLI

**交付物**：
```
.claude/
├── skills/
│   ├── product-launch/SKILL.md    ✓ 完整可用
│   └── menu-management/SKILL.md   ✓ 完整可用
├── knowledge/
│   └── system-guide.md            ✓ 系统操作指南
└── mcp.json                       ✓ Playwright 配置
```

**成功指标**：
- [ ] 2 个核心 Skills 完成并可执行
- [ ] 执行成功率 > 80%
- [ ] 用户满意度 > 4/5

### 8.2 P1 阶段：扩展推广（2-3 个月）

**目标**：降低使用门槛，扩大用户群

**范围**：
- 用户：50+ 普通运营人员
- 场景：扩展到价格调整、活动配置
- 工具：轻量 Web 应用 + Claude Code

**交付物**：
```
新增 Skills:
├── price-adjustment/SKILL.md      价格调整
├── campaign-setup/SKILL.md        活动配置
└── inventory-check/SKILL.md       库存查询

Web 应用:
├── 场景快捷入口
├── 执行状态可视化
└── 历史记录查询

Agent SDK 集成:
├── 解析企业扩展字段
├── 审批流程集成
└── 权限校验
```

**成功指标**：
- [ ] 5+ Skills 投入使用
- [ ] 自助完成率 > 50%
- [ ] 人均效率提升 > 30%

### 8.3 P2 阶段：规模化（3-6 个月）

**目标**：全面提效，形成 Skills 生态

**范围**：
- 用户：全体运营人员
- 场景：覆盖 80% 日常运营操作
- 工具：企业级应用平台

**交付物**：
```
Skills 生态:
├── 20+ 业务 Skills
├── Skills 市场（发现、安装、评价）
├── 自定义 Skills 创建工具

企业平台:
├── 统一身份认证
├── 角色权限管理
├── 审批流程引擎
├── 审计日志系统
├── 数据分析看板

运维体系:
├── Skills 版本管理
├── 灰度发布机制
├── 监控告警系统
├── 自动回滚机制
```

**成功指标**：
- [ ] 20+ Skills 覆盖主要场景
- [ ] 自助完成率 > 70%
- [ ] 运营效率提升 > 50%
- [ ] Skills 复用率 > 60%

---

## 9. 典型场景实现

### 9.1 场景：商品上新

**用户输入**：
```
帮我上新一个商品，名字叫"燕麦拿铁"，定价32元，先在华东区试点
```

**执行流程**：

```
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: Master Agent 意图分析                                    │
├─────────────────────────────────────────────────────────────────┤
│ Intent: product_launch                                          │
│ Entities:                                                       │
│   - product_name: "燕麦拿铁"                                     │
│   - price: 32                                                   │
│   - regions: ["华东区"]                                          │
│ Matched Skill: product-launch                                   │
│ Approval Required: No (price < 100, not 全国)                   │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: 加载 Skill 并执行                                        │
├─────────────────────────────────────────────────────────────────┤
│ Load: .claude/skills/product-launch/SKILL.md                    │
│ Load: .claude/skills/product-launch/references/erp-guide.md     │
│                                                                 │
│ Execute Step 1: 登录商品中台                                     │
│   → mcp__playwright__browser_navigate("https://erp.example.com")│
│   → mcp__playwright__browser_fill_form([...])                   │
│   → mcp__playwright__browser_click("登录")                      │
│                                                                 │
│ Execute Step 2: 创建商品                                         │
│   → mcp__playwright__browser_navigate("/product/create")        │
│   → mcp__playwright__browser_fill_form([                        │
│       { name: "商品名称", value: "燕麦拿铁" },                   │
│       { name: "销售价格", value: "32" },                        │
│       { name: "上架区域", value: "华东区" }                      │
│     ])                                                          │
│   → mcp__playwright__browser_click("保存")                      │
│   → 提取 product_id: "PRD_20240115_001"                         │
│                                                                 │
│ Execute Step 3: 同步 POS                                         │
│   → ...                                                         │
│                                                                 │
│ Execute Step 4: 同步 APP                                         │
│   → ...                                                         │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│ Step 3: 返回结果并记录                                           │
├─────────────────────────────────────────────────────────────────┤
│ Result:                                                         │
│   product_id: "PRD_20240115_001"                                │
│   sync_status:                                                  │
│     erp: success                                                │
│     pos: success                                                │
│     app: success                                                │
│                                                                 │
│ Save to: .claude/executions/exec_20240115_001.json              │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 场景：跨领域协作（新品发布活动）

**用户输入**：
```
下周一发布新品"樱花季限定拿铁"，定价38元，同时配套满30减5的活动
```

**执行流程**：

```
┌─────────────────────────────────────────────────────────────────┐
│ Master Agent 任务分解                                            │
├─────────────────────────────────────────────────────────────────┤
│ Task 1: 商品上新 → Product Agent                                 │
│   skill: product-launch                                         │
│   params: { name: "樱花季限定拿铁", price: 38, launch: "周一" } │
│                                                                 │
│ Task 2: 活动配置 → Marketing Agent                               │
│   skill: campaign-setup                                         │
│   params: { type: "满减", threshold: 30, discount: 5 }          │
│   dependency: Task 1 完成后执行                                  │
│                                                                 │
│ Approval: Required (新品 + 活动联动)                             │
│   approvers: [商品经理, 营销经理]                                │
└──────────────────────────┬──────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│ Workflow 编排执行                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────┐     ┌──────────┐     ┌──────────┐               │
│   │ 创建商品 │ ──→ │ 审批节点 │ ──→ │ 配置活动 │               │
│   │ Task 1   │     │ 等待批准 │     │ Task 2   │               │
│   └──────────┘     └──────────┘     └──────────┘               │
│                          ↑                                      │
│                    Human Approval                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. 治理与运维

### 10.1 Skills 治理

```
┌─────────────────────────────────────────────────────────────────┐
│                     Skills 治理框架                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  版本管理                                                │   │
│  │  • Git 版本控制                                          │   │
│  │  • 语义化版本号（major.minor.patch）                      │   │
│  │  • 变更日志（CHANGELOG.md）                              │   │
│  │  • 发布审核流程                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  质量保障                                                │   │
│  │  • Skills 测试用例                                       │   │
│  │  • 沙箱环境验证                                          │   │
│  │  • 灰度发布（5% → 20% → 50% → 100%）                    │   │
│  │  • 回滚机制                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  安全合规                                                │   │
│  │  • 敏感操作审批                                          │   │
│  │  • 数据访问权限                                          │   │
│  │  • 操作审计日志                                          │   │
│  │  • 合规性检查                                            │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 10.2 监控指标

| 指标类别 | 具体指标 | 告警阈值 |
|---------|---------|---------|
| **执行质量** | 成功率 | < 90% |
| | 平均耗时 | > 预估时间 2x |
| | 重试次数 | > 3 次/执行 |
| **使用情况** | 日活跃用户 | - |
| | Skill 调用次数 | - |
| | 热门 Skills Top 10 | - |
| **系统健康** | MCP 连接状态 | 断开 |
| | API 响应时间 | > 5s |
| | 错误率 | > 5% |

### 10.3 应急预案

```
┌─────────────────────────────────────────────────────────────────┐
│  故障等级与响应                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  P0 - 全局不可用                                                │
│  • 影响：所有 Skills 无法执行                                    │
│  • 响应：15 分钟内响应，1 小时内恢复                             │
│  • 措施：切换备用 MCP 服务 / 回滚最近变更                        │
│                                                                 │
│  P1 - 核心 Skill 故障                                           │
│  • 影响：单个核心 Skill 不可用                                   │
│  • 响应：30 分钟内响应，2 小时内恢复                             │
│  • 措施：回滚 Skill 版本 / 提供手动操作指南                      │
│                                                                 │
│  P2 - 非核心功能异常                                             │
│  • 影响：辅助功能受损                                            │
│  • 响应：4 小时内响应，24 小时内恢复                             │
│  • 措施：记录问题，排期修复                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 11. 当前实现状态

本节描述当前代码库中已实现的模块和功能。

### 11.1 已实现模块概览

```
┌─────────────────────────────────────────────────────────────────┐
│                      当前实现架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  统一执行引擎 (skills_engine.py)                         │   │
│  │  UnifiedSkillsEngine                                     │   │
│  │  • execute() - Skill 执行入口                            │   │
│  │  • load_skill() / list_skills() / search_skills()       │   │
│  │  • get_metrics() / get_skill_stats()                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│         ┌────────────────────┼────────────────────┐             │
│         ▼                    ▼                    ▼             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ LLM Provider│    │ Tool Router │    │ Governance  │         │
│  │  抽象层     │    │  工具路由   │    │  治理系统   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│         │                    │                    │             │
│         ▼                    ▼                    ▼             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ • Claude    │    │ • Builtin   │    │ • Metrics   │         │
│  │ • OpenAI    │    │ • MCP       │    │ • Audit     │         │
│  │ • Gemini    │    │ • Playwright│    │ • Safety    │         │
│  │ • Ollama    │    │ • Custom    │    │ • Alerts    │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  知识捕获系统 (capture/)                                 │   │
│  │  • Recorder - Chrome 操作录制                            │   │
│  │  • Generator - SKILL.md 生成                             │   │
│  │  • Refiner - 参数化优化                                  │   │
│  │  • VectorStore - 语义搜索                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  四层 Agent 架构 (layers/)                               │   │
│  │  • MasterAgent - 意图路由                                │   │
│  │  • SubAgentManager - 领域专家                            │   │
│  │  • WorkflowEngine - 流程编排                             │   │
│  │  • SkillExecutor - 原子执行                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 11.2 LLM Provider 实现

| Provider | 文件 | 状态 | 支持模型 |
|----------|------|------|----------|
| Claude | `providers/claude_provider.py` | ✅ 完成 | claude-sonnet-4, claude-opus-4 等 |
| OpenAI | `providers/openai_provider.py` | ✅ 完成 | gpt-4o, gpt-4-turbo 等 |
| Gemini | `providers/gemini_provider.py` | ✅ 完成 | gemini-1.5-pro 等 |
| Ollama | `providers/ollama_provider.py` | ✅ 完成 | llama3, mistral 等本地模型 |

**统一接口**：
```python
# providers/base.py
class BaseLLMProvider(ABC):
    def chat(messages, tools, max_tokens, temperature) -> LLMResponse
    def stream_chat(messages, tools, ...) -> Generator[str, None, LLMResponse]
```

**切换方式**：
```python
# 通过环境变量
LLM_PROVIDER=openai
LLM_MODEL=gpt-4o

# 或通过 API
POST /api/v2/provider
{"provider": "gemini", "model": "gemini-1.5-pro"}
```

### 11.3 工具路由实现

```python
# tool_router.py
class ToolRouter:
    """统一工具管理"""

    # 内置工具
    - bash      # 命令执行 (EXECUTE)
    - read      # 文件读取 (READ)
    - write     # 文件写入 (WRITE)
    - glob      # 文件搜索 (READ)
    - grep      # 内容搜索 (READ)

    # 访问级别控制
    class ToolAccessLevel(Enum):
        READ = "read"       # 只读
        WRITE = "write"     # 写入
        EXECUTE = "execute" # 执行
        ADMIN = "admin"     # 管理
```

### 11.4 治理系统实现

| 模块 | 文件 | 功能 |
|------|------|------|
| Metrics | `governance/metrics.py` | 成功率、耗时、吞吐量统计 |
| Audit | `governance/audit.py` | 执行记录、工具调用审计 |
| Safety | `governance/safety.py` | 权限检查、危险模式检测 |
| Alerts | `governance/alerts.py` | 规则告警、阈值监控 |

**监控指标**：
```python
class MetricScope(Enum):
    SKILL = "skill"
    WORKFLOW = "workflow"
    AGENT = "agent"
    SYSTEM = "system"
    TOOL = "tool"

# 聚合指标
- success_rate (成功率)
- avg_duration_ms (平均耗时)
- p50/p90/p99_duration_ms (延迟分位)
- error_count (错误计数)
```

### 11.5 知识捕获实现

| 模块 | 文件 | 功能 |
|------|------|------|
| Recorder | `capture/recorder.py` | 记录浏览器操作 (click, input, navigate) |
| Generator | `capture/generator.py` | 操作序列 → SKILL.md 转换 |
| Refiner | `capture/refiner.py` | 参数提取、选择器优化 |
| Repository | `capture/repository.py` | Skills 存储和检索 |
| VectorStore | `capture/vector_store.py` | 向量化存储和语义搜索 |

**向量存储支持**：
- Voyage AI Embeddings (推荐)
- OpenAI Embeddings (备选)
- 本地 NumPy 相似度 (开发环境)

### 11.6 API 端点实现

#### V2 Skills API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v2/skills/{id}/execute` | POST | 执行 Skill |
| `/api/v2/skills` | GET | 列出所有 Skills |
| `/api/v2/skills/search` | GET | 语义搜索 |
| `/api/v2/skills/{id}/stats` | GET | 获取统计 |
| `/api/v2/provider` | GET/POST | 获取/切换 Provider |
| `/api/v2/status` | GET | 系统状态 |

#### Governance API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/governance/metrics` | GET | 监控指标 |
| `/api/governance/alerts` | GET | 告警列表 |
| `/api/governance/audit` | GET | 审计日志 |

#### Capture API
| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/capture/recording/start` | POST | 开始录制 |
| `/api/capture/recording/stop` | POST | 停止录制 |
| `/api/capture/generate` | POST | 生成 SKILL.md |
| `/api/capture/refine` | POST | 优化 Skill |

### 11.7 落地阶段对照

| 阶段 | 计划功能 | 实现状态 |
|------|---------|---------|
| **P0** | Skills 基础执行 | ✅ 完成 |
| | SKILL.md 解析 | ✅ 完成 |
| | 基础 MCP 集成 | ✅ 完成 |
| **P1** | 多 LLM Provider | ✅ 完成 |
| | 工具路由系统 | ✅ 完成 |
| | 执行监控 | ✅ 完成 |
| **P2** | 知识捕获 | ✅ 完成 |
| | 语义搜索 | ✅ 完成 |
| | 告警系统 | ✅ 完成 |
| **P3** | 审批流程 | 🔄 规划中 |
| | 企业 SSO | 🔄 规划中 |
| | 灰度发布 | 🔄 规划中 |

---

## 12. 附录

### 12.1 术语表

| 术语 | 英文 | 定义 |
|------|------|------|
| 技能 | Skill | 封装特定业务操作的可复用单元 |
| 记忆 | Memory | Agent 的知识和经验存储 |
| 程序性记忆 | Procedural Memory | Agent 的行为模式和工具能力 |
| 语义记忆 | Semantic Memory | 领域知识和操作技能 |
| 情景记忆 | Episodic Memory | 历史执行记录 |
| MCP | Model Context Protocol | 模型上下文协议，用于工具集成 |
| 审批流 | Approval Workflow | 关键操作的人工审核流程 |

### 12.2 参考资料

- [Claude Code Skills Documentation](https://docs.anthropic.com/claude-code/skills)
- [Vercel Agent Skills](https://github.com/vercel-labs/agent-skills)
- [MCP Protocol Specification](https://modelcontextprotocol.io/)
- [Playwright MCP](https://github.com/anthropics/mcp-playwright)

### 12.3 文件模板

#### SKILL.md 模板

```yaml
---
name: skill-name
description: |
  技能描述。说明这个技能做什么。
  当用户提到：关键词1、关键词2 时使用。
allowed-tools:
  - mcp__playwright__browser_*
  - Read

# 企业扩展字段
version: "1.0"
category: 分类名称
owner: 负责团队
tags: [标签1, 标签2]

inputs:
  - name: param1
    type: string
    required: true
    description: 参数说明

target_systems:
  - id: system_id
    name: 系统名称
    type: WEB

approval:
  required: false
  rules: []

execution:
  estimated_duration: 10min
  rollback_supported: true
---

# 技能名称

## 概述
简要说明技能用途。

## 前置条件
- 条件1
- 条件2

## 执行步骤

### Step 1: 步骤名称
具体操作说明...

### Step 2: 步骤名称
具体操作说明...

## 常见问题

### Q1: 问题描述
解决方案...

## 回滚操作
如需回滚...

## 变更记录
| 版本 | 日期 | 说明 | 作者 |
|------|------|------|------|
| 1.0 | YYYY-MM-DD | 初始版本 | - |
```

---

## 文档版本

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|---------|
| 1.0 | 2024-01-15 | - | 初始版本 |
| 2.0 | 2025-01-15 | - | 添加多 LLM Provider、工具路由、治理系统 |
| 2.1 | 2025-01-18 | - | 添加知识捕获、语义搜索、当前实现状态章节 |

---

*本文档持续更新，如有问题请联系运营平台团队。*
